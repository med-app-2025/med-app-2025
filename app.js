function saveOfflineRecord(record){let r=JSON.parse(localStorage.getItem('attendanceRecords')||'[]');r.push(record);localStorage.setItem('attendanceRecords',JSON.stringify(r));}
function sendSavedRecords(){let r=JSON.parse(localStorage.getItem('attendanceRecords')||'[]');if(r.length>0&&navigator.onLine){r.forEach(function(record){google.script.run.recordLocation(record.latitude,record.longitude,record.name,record.place,record.subject);});localStorage.removeItem('attendanceRecords');}}
function sendLocation(){var s=document.getElementById("name").value||"غير معروف";var sub=document.getElementById("subject").value||"غير معروف";var p=document.getElementById("place").value||"غير معروف";if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(pos){let rec={name:s,subject:sub,place:p,latitude:pos.coords.latitude,longitude:pos.coords.longitude,timestamp:new Date()};if(navigator.onLine){google.script.run.withSuccessHandler(function(){showSuccess(rec);}).recordLocation(rec.latitude,rec.longitude,rec.name,rec.place,rec.subject);}else{saveOfflineRecord(rec);showSuccess(rec,true);}},function(err){alert("فشل تحديد الموقع. الرجاء تفعيل GPS.");},{enableHighAccuracy:true,maximumAge:0,timeout:10000});}else{alert("متصفحك لا يدعم تحديد الموقع.");}}
function showSuccess(r,offline=false){var a=document.getElementById("messageAlert");var f=document.getElementById("formContainer");f.querySelectorAll("input,button").forEach(el=>el.style.display="none");a.style.display="block";a.className=offline?"alert success":"alert success";a.innerText=offline?"تم حفظ بياناتك مؤقتاً وسيتم إرسالها عند توفر الإنترنت!":"تم تسجيل موقعك بنجاح!";if(!offline){var g=document.getElementById("googleMapLink");g.href="https://www.google.com/maps?q="+r.latitude+","+r.longitude;g.innerText="عرض الموقع في Google Maps";g.style.display="block";showMap(r.latitude,r.longitude);}}
function showMap(lat,lng){var m=document.getElementById("map");m.style.display="block";m.innerHTML='<iframe width="320" height="200" frameborder="0" style="border:0" src="https://www.google.com/maps?q='+lat+','+lng+'&hl=ar&z=16&output=embed" allowfullscreen></iframe>';}
window.addEventListener('load',sendSavedRecords);
window.addEventListener('online',sendSavedRecords);